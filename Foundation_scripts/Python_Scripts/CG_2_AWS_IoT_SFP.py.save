m6import time
import json
import random
from awscrt import mqtt
from awsiot import mqtt_connection_builder

# 1. Setup the Address and Identity
ENDPOINT = "a1kefksbmaj4e4-ats.iot.us-east-1.amazonaws.com"                 #AWS End-Point Unique to individual users "I got mine from the terminal"
CLIENT_ID = "SmartFarm_Pi_01"                                               #THIS IS MY "THING" Created in IoT Core (Match both script and AWS title)

# 2. Point to the Security Keys (All these files are together in a single folder inside the Raspy!!!)
PATH_TO_CERT = "/home/oscariot/GG_Gits/certs/certificate.pem.crt"        #Point to certificates loaded onto Raspy
PATH_TO_KEY = "/home/oscariot/GG_Gits/certs//private.pem.key"             #Point to Key loaded onto Raspy
PATH_TO_ROOT_CA = "/home/oscariot/GG_Gits/certs/AmazonRootCA1.pem"       #Point to RootCA1 loaded onto Raspy

# 3. Create the Connection Object
mqtt_connection = mqtt_connection_builder.mtls_from_path(
    endpoint=ENDPOINT,
    cert_filepath=PATH_TO_CERT,
    pri_key_filepath=PATH_TO_KEY,
    ca_filepath=PATH_TO_ROOT_CA,
    client_id=CLIENT_ID,
    clean_session=False,
    keep_alive_secs=30
)

# 4. Open the Connection
print("Connecting...")
connect_future = mqtt_connection.connect()
connect_future.result() 
print("Connected!")

# 5. Send a Message (Here is where we can edit the code to fit our needs :D)
#Change to farm/sensors to match AWS IoT Core Rule
# Add timestep and device id to script    
#payload = {"status": "online", "message": "Farm Pi is active"}  #Edit messages to communicate Raspi -> AWS IoT Core MQTT ({})

try:
    while True:
        # --- START OF YOUR MANIPULATION ---
        # Simulate a temperature that fluctuates around 24 degrees
        sim_temp = round(random.uniform(20.0, 28.0), 2)
        sim_node_type = round(random.randint(1, 10), 2)
        sim_node_id = round(random.randint(1, 10), 2)
        sim_health = round(random.randint(0, 2), 2)

        # SimulatING static moisture"
        sim_moisture = 65.5; 
        
        
        payload = {
            "device_id": CLIENT_ID,
            "node_type": sim_node_type,
            "node_id": sim_node_id,

            
            "health_class": sim_health,         #UPDATE
            "temperature": sim_temp,            #REMOVE
            "soil_moisture": sim_moisture,           #UPDATE


            "battery": 100, #Place holder for now
            "status": "active",
            "message" : "Incorporating Dynamic Var temp",

            "timestamp": int(time.time()),
        }
        # --- END OF MANIPULATION ---

        print(f"Sending data: {payload}")
        mqtt_connection.publish(
            topic="farm/sensors",
            payload=json.dumps(payload),
            qos=mqtt.QoS.AT_LEAST_ONCE
        )
        
        time.sleep(10) # Change this depending on how often data will be sent (10 sec at this point)
except KeyboardInterrupt:
    print("Stopped by user")

# 6. Close the Connection
disconnect_future = mqtt_connection.disconnect()
disconnect_future.result()


